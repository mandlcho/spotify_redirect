<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotify Now Playing</title>
  <style>
    :root {
      --bg: #f7f7f7;
      --panel: #ffffff;
      --text: #1c1c1c;
      --muted: #6b6b6b;
      --accent: #111111;
      --accent-2: #e3e3e3;
      --border: #dcdcdc;
      --shadow: 0 6px 30px rgba(0, 0, 0, 0.08);
      --mono: "Consolas", "SFMono-Regular", ui-monospace, Menlo, Consolas, "Liberation Mono", monospace;
      font-family: 'Consolas', 'SFMono-Regular', ui-monospace, monospace;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 32px 18px 60px;
    }
    main { width: min(860px, 100%); }
    .winamp {
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: var(--shadow);
    }
    .titlebar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      background: #f1f1f1;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      letter-spacing: 0.03em;
      color: var(--text);
    }
    .titlebar .lights {
      display: flex;
      gap: 6px;
    }
    .light {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      background: #2f2f2f;
      border: 1px solid #050505;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.4);
    }
    .light.on { background: #32ff77; box-shadow: 0 0 8px #32ff77, inset 0 -2px 0 rgba(0,0,0,0.4); }

    .title-actions { display: flex; align-items: center; gap: 10px; }
    .mini-btn {
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      box-shadow: none;
    }
    .panel {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      padding: 16px;
    }

    .section {
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 16px;
      border-radius: 10px;
    }

    h1 { margin: 0 0 8px; letter-spacing: 0.01em; font-size: 18px; color: var(--text); font-weight: 700; }
    p { margin: 0; color: var(--muted); line-height: 1.5; font-weight: 500; }
    label { display: block; margin: 12px 0 6px; font-weight: 600; }
    input[type="text"] {
      width: 100%;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fafafa;
      color: var(--text);
      font-family: var(--mono);
      box-shadow: none;
    }
    button {
      border: none;
      background: var(--accent);
      color: #fdfdfd;
      padding: 12px 16px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      transition: transform 120ms ease, box-shadow 120ms ease;
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
      font-size: 13px;
    }
    button.secondary { background: #fff; color: var(--text); border: 1px solid var(--border); box-shadow: none; }
    button:active { transform: translateY(1px); }

    .row { display: flex; justify-content: space-between; gap: 10px; padding: 10px 12px; border-radius: 8px; background: #fafafa; border: 1px solid var(--border); }
    .row .label { color: var(--muted); font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.04em; }
    .row .value { font-family: var(--mono); word-break: break-all; text-align: right; color: var(--text); }
    .status { display: inline-flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 8px; font-weight: 700; font-size: 11px; }
    .ok { background: #e7f6ed; color: #0f8b4b; border: 1px solid #b7dfc6; }
    .warn { background: #fff7e0; color: #b38600; border: 1px solid #e7d4a4; }
    .error { background: #ffe8e8; color: #b42525; border: 1px solid #e6b1b1; }
    .track {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 14px;
      align-items: center;
    }
    .art {
      width: 140px;
      height: 140px;
      border-radius: 8px;
      background: #f4f4f4;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #7a7a7a;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    .art img { width: 100%; height: 100%; object-fit: cover; }
    .track h3 { margin: 0; font-family: var(--mono); letter-spacing: 0.01em; font-size: 16px; color: var(--text); }
    .track .artists { margin: 6px 0 0; color: var(--muted); font-family: var(--mono); font-size: 12px; }
    .hidden { display: none !important; }
    pre {
      background: #0f0f0f;
      border: 1px solid #0f0f0f;
      border-radius: 8px;
      padding: 12px;
      overflow: auto;
      font-family: var(--mono);
      font-size: 0.9rem;
      max-height: 240px;
      color: #d1f1d7;
    }
    @media (max-width: 640px) {
      .panel { grid-template-columns: 1fr; }
      .track { grid-template-columns: 1fr; }
      .art { width: 100%; height: auto; aspect-ratio: 1 / 1; }
    }
  </style>
</head>
<body>
  <main class="winamp">
    <div class="titlebar">
      <span>Spotify Now Playing</span>
      <div class="title-actions">
        <button class="mini-btn" id="toggle-settings">Show Settings</button>
      </div>
    </div>
    <div class="panel">
      <section class="section" id="settings-panel">
        <h1>Connect</h1>
        <p>Register the redirect URI below in your Spotify app, then connect. Tokens stay in your browser.</p>
        <div class="row" style="margin-top:10px;">
          <div class="label">Redirect URI</div>
          <div class="value" id="redirect-uri">—</div>
        </div>
        <button class="secondary" id="copy-redirect">Copy Redirect URI</button>

        <label for="client-id">Spotify Client ID</label>
        <input id="client-id" type="text" placeholder="Paste your client_id" autocomplete="off" spellcheck="false">
        <button id="save-client">Save Client ID</button>
        <button class="secondary" id="connect">Connect to Spotify</button>
        <button class="secondary" id="clear">Clear stored tokens</button>
        <div class="row" style="margin-top:10px;">
          <div class="label">Auth</div>
          <div class="value" id="auth-state"><span class="status warn">Not connected</span></div>
        </div>
      </section>

      <section class="section">
        <h1>Now Playing</h1>
        <div class="track">
          <div class="art" id="art">No artwork</div>
          <div>
            <h3 id="title">Nothing playing</h3>
            <div class="artists" id="artists">—</div>
            <div style="margin-top:10px;" class="row">
              <div class="label">Polling</div>
              <div class="value" id="polling">Every 10s</div>
            </div>
            <div class="row">
              <div class="label">Album</div>
              <div class="value" id="album">—</div>
            </div>
            <div class="row">
              <div class="label">Year</div>
              <div class="value" id="year">—</div>
            </div>
            <div class="row">
              <div class="label">Track ID</div>
              <div class="value mono" id="track-id">—</div>
            </div>
          </div>
        </div>
        <pre id="raw">{}</pre>
      </section>
    </div>
  </main>

  <script>
    const scopes = ['user-read-currently-playing', 'user-read-playback-state'];
    const redirectUri = window.location.origin + window.location.pathname;

    const storage = {
      client: 'np_client_id',
      access: 'np_access',
      refresh: 'np_refresh',
      expiry: 'np_expiry',
      verifier: 'np_verifier'
    };

    const clientInput = document.getElementById('client-id');
    const redirectEl = document.getElementById('redirect-uri');
    const copyRedirectBtn = document.getElementById('copy-redirect');
    const saveBtn = document.getElementById('save-client');
    const connectBtn = document.getElementById('connect');
    const clearBtn = document.getElementById('clear');
    const authState = document.getElementById('auth-state');
    const titleEl = document.getElementById('title');
    const artistsEl = document.getElementById('artists');
    const artEl = document.getElementById('art');
    const rawEl = document.getElementById('raw');
    const pollingEl = document.getElementById('polling');
    const albumEl = document.getElementById('album');
    const yearEl = document.getElementById('year');
    const trackIdEl = document.getElementById('track-id');
    const settingsPanel = document.getElementById('settings-panel');
    const toggleSettingsBtn = document.getElementById('toggle-settings');

    function badge(text, cls) {
      return `<span class="status ${cls}">${text}</span>`;
    }

    function randomString(len = 64) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      const array = new Uint32Array(len);
      crypto.getRandomValues(array);
      return Array.from(array).map((x) => chars[x % chars.length]).join('');
    }

    async function sha256(input) {
      const data = new TextEncoder().encode(input);
      return crypto.subtle.digest('SHA-256', data);
    }

    function b64url(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
    }

    function renderAuth(text, cls = 'warn') {
      authState.innerHTML = badge(text, cls);
    }

    function storeTokens(data, includeRefresh = true) {
      if (data.access_token) localStorage.setItem(storage.access, data.access_token);
      if (includeRefresh && data.refresh_token) localStorage.setItem(storage.refresh, data.refresh_token);
      const expiry = Date.now() + ((data.expires_in || 3600) * 1000) - 60000;
      localStorage.setItem(storage.expiry, String(expiry));
    }

    async function startAuth() {
      const clientId = clientInput.value.trim();
      if (!clientId) return renderAuth('Missing client_id', 'error');
      localStorage.setItem(storage.client, clientId);
      const verifier = randomString(64);
      localStorage.setItem(storage.verifier, verifier);
      const challenge = b64url(await sha256(verifier));
      const url = new URL('https://accounts.spotify.com/authorize');
      url.searchParams.set('client_id', clientId);
      url.searchParams.set('response_type', 'code');
      url.searchParams.set('redirect_uri', redirectUri);
      url.searchParams.set('code_challenge_method', 'S256');
      url.searchParams.set('code_challenge', challenge);
      url.searchParams.set('scope', scopes.join(' '));
      url.searchParams.set('state', randomString(12));
      window.location.href = url.toString();
    }

    async function exchangeCode(code) {
      const clientId = localStorage.getItem(storage.client);
      const verifier = localStorage.getItem(storage.verifier);
      const body = new URLSearchParams({
        client_id: clientId,
        grant_type: 'authorization_code',
        code,
        redirect_uri: redirectUri,
        code_verifier: verifier
      });
      const resp = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      if (!resp.ok) throw new Error(`Token exchange failed (${resp.status})`);
      const data = await resp.json();
      storeTokens(data);
      renderAuth('Connected', 'ok');
    }

    async function refreshAccess() {
      const refresh = localStorage.getItem(storage.refresh);
      const clientId = localStorage.getItem(storage.client);
      if (!refresh || !clientId) throw new Error('No refresh token');
      const body = new URLSearchParams({
        grant_type: 'refresh_token',
        refresh_token: refresh,
        client_id: clientId
      });
      const resp = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      if (!resp.ok) throw new Error(`Refresh failed (${resp.status})`);
      const data = await resp.json();
      storeTokens(data, false);
      renderAuth('Connected', 'ok');
    }

    async function ensureAccessToken() {
      const access = localStorage.getItem(storage.access);
      const expiry = Number(localStorage.getItem(storage.expiry));
      if (access && expiry && Date.now() < expiry) return access;
      await refreshAccess();
      return localStorage.getItem(storage.access);
    }

    function clearTokens() {
      Object.values(storage).forEach((k) => localStorage.removeItem(k));
      renderAuth('Tokens cleared', 'warn');
      titleEl.textContent = 'Nothing playing';
      artistsEl.textContent = '—';
      artEl.textContent = 'No artwork';
      albumEl.textContent = '—';
      yearEl.textContent = '—';
      trackIdEl.textContent = '—';
      rawEl.textContent = '{}';
    }

    async function fetchNowPlaying() {
      try {
        const token = await ensureAccessToken();
        if (!token) return;
        const resp = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (resp.status === 204) {
          titleEl.textContent = 'Nothing playing';
          artistsEl.textContent = '—';
          artEl.textContent = 'No artwork';
          rawEl.textContent = '{}';
          return;
        }
        if (resp.status === 401) {
          await refreshAccess();
          return;
        }
        if (!resp.ok) throw new Error(`Now playing failed (${resp.status})`);
        const data = await resp.json();
        rawEl.textContent = JSON.stringify(data, null, 2);
        if (data?.item) {
          titleEl.textContent = data.item.name || 'Unknown track';
          artistsEl.textContent = (data.item.artists || []).map((a) => a.name).join(', ') || 'Unknown artist';
          albumEl.textContent = data.item.album?.name || 'Unknown album';
          yearEl.textContent = (data.item.album?.release_date || '—').slice(0, 4) || '—';
          trackIdEl.textContent = data.item.id || '—';
          const img = data.item.album?.images?.[0]?.url;
          if (img) artEl.innerHTML = `<img src="${img}" alt="Album art">`;
          else artEl.textContent = 'No artwork';
        } else {
          titleEl.textContent = 'Nothing playing';
          artistsEl.textContent = '—';
          artEl.textContent = 'No artwork';
          albumEl.textContent = '—';
          yearEl.textContent = '—';
          trackIdEl.textContent = '—';
        }
      } catch (err) {
      renderAuth(err.message || 'Error', 'error');
    }
  }

    function toggleSettings(forceHide) {
      const currentlyHidden = settingsPanel.classList.contains('hidden');
      const shouldHide = typeof forceHide === 'boolean' ? forceHide : !currentlyHidden;
      if (shouldHide) {
        settingsPanel.classList.add('hidden');
        toggleSettingsBtn.textContent = 'Show Settings';
      } else {
        settingsPanel.classList.remove('hidden');
        toggleSettingsBtn.textContent = 'Hide Settings';
      }
    }

    function handleRedirect() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      if (code) {
        exchangeCode(code)
          .then(() => {
            params.delete('code');
            params.delete('state');
            const next = `${window.location.origin}${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
            window.history.replaceState({}, document.title, next);
            fetchNowPlaying();
          })
          .catch((err) => renderAuth(err.message || 'Exchange failed', 'error'));
      }
    }

    function copyRedirect() {
      navigator.clipboard?.writeText(redirectUri)
        .then(() => copyRedirectBtn.textContent = 'Copied!')
        .catch(() => copyRedirectBtn.textContent = 'Copy failed');
      setTimeout(() => copyRedirectBtn.textContent = 'Copy Redirect URI', 1200);
    }

    function init() {
      redirectEl.textContent = redirectUri;
      pollingEl.textContent = 'Every 10s';
      const storedClient = localStorage.getItem(storage.client);
      if (storedClient) clientInput.value = storedClient;
      if (localStorage.getItem(storage.access)) renderAuth('Connected', 'ok');
      // Hide settings on first load (brutalist minimal view)
      toggleSettings(true);
      handleRedirect();
      fetchNowPlaying();
      setInterval(fetchNowPlaying, 10000);
    }

    saveBtn.addEventListener('click', () => {
      const cid = clientInput.value.trim();
      if (!cid) return;
      localStorage.setItem(storage.client, cid);
      renderAuth('Client ID saved', 'ok');
    });
    connectBtn.addEventListener('click', startAuth);
    clearBtn.addEventListener('click', clearTokens);
    copyRedirectBtn.addEventListener('click', copyRedirect);
    toggleSettingsBtn.addEventListener('click', () => toggleSettings());
    init();
  </script>
</body>
</html>
